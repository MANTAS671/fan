<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Baby Bump Defender</title>
<meta name="description" content="–ò–≥—Ä–∞ –¥–ª—è –±—É–¥—É—â–µ–π –º–∞–º—ã: —Å–æ–±–∏—Ä–∞–π —Ö–æ—Ä–æ—à–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏ (‚ù§Ô∏è), –∏–∑–±–µ–≥–∞–π —Å—Ç—Ä–µ—Å—Å–∞ (üí£), –¥–∞—Ä–∏ –º–∞–ª—ã—à—É —Å—á–∞—Å—Ç—å–µ.">
<style>
  :root {
    --bg:#0f111a;
    --card:#1f2135;
    --radius:14px;
    --accent1:#ff6b6b;
    --accent2:#ff9f43;
    --text:#e3e8ff;
    --muted:#8f97b3;
    --shadow:0 25px 60px -10px rgba(0,0,0,0.45);
    --transition:.18s cubic-bezier(.22,.61,.36,1);
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  }
  *{box-sizing:border-box;}
  body {
    margin:0;
    min-height:100vh;
    background: linear-gradient(135deg,#0f111a 0%,#1f2135 90%);
    color: var(--text);
    -webkit-font-smoothing:antialiased;
    line-height:1.2;
    display:flex;
    justify-content:center;
    padding:12px 8px;
  }
  .app {
    width:100%;
    max-width:500px;
    display:flex;
    flex-direction:column;
    gap:10px;
    position:relative;
  }
  header {
    display:flex;
    flex-wrap:wrap;
    justify-content:space-between;
    gap:8px;
    align-items:flex-start;
  }
  h1 {
    margin:0;
    font-size:1.5rem;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .small {
    font-size:0.65rem;
    color: var(--muted);
    margin-top:2px;
  }
  .name-section {
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    align-items:center;
    font-size:0.8rem;
  }
  .name-section label {
    flex-shrink:0;
  }
  .name-section input {
    padding:8px 14px;
    border-radius:999px;
    border:none;
    outline:none;
    font-size:0.9rem;
    background: rgba(255,255,255,0.06);
    color:#fff;
    min-width:130px;
    flex:1;
  }
  #game-area {
    position:relative;
    background:rgba(255,255,255,0.02);
    border-radius:16px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    gap:8px;
    padding:12px 12px 6px;
  }
  canvas {
    width:100%;
    aspect-ratio:9/16;
    background: linear-gradient(135deg,#1f233c,#0f111a);
    border-radius:12px;
    touch-action:none;
    display:block;
  }
  .info {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(100px,1fr));
    gap:6px;
    font-size:0.75rem;
  }
  .info div {
    background: rgba(255,255,255,0.045);
    padding:8px 11px;
    border-radius:10px;
    display:flex;
    flex-direction:column;
    gap:3px;
    position:relative;
  }
  .info strong {
    display:block;
    font-size:0.95rem;
  }
  .message-box {
    background: rgba(255,255,255,0.03);
    padding:10px 14px;
    border-radius:10px;
    font-size:0.9rem;
    min-height:48px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }
  .controls {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
  }
  button {
    padding:14px 16px;
    border:none;
    cursor:pointer;
    border-radius:999px;
    font-weight:600;
    font-size:1rem;
    background: linear-gradient(135deg,var(--accent1) 10%, var(--accent2) 90%);
    color:#fff;
    flex:1;
    min-width:100px;
    position:relative;
    overflow:hidden;
    transition: transform var(--transition), filter .2s;
    box-shadow:0 15px 40px -5px rgba(255,107,107,0.55);
  }
  button:active { transform:scale(.95); }
  .secondary {
    background: rgba(255,255,255,0.08);
    color: var(--text);
    box-shadow:0 15px 40px -5px rgba(0,0,0,0.3);
  }
  .help-badge {
    position:fixed;
    bottom:16px;
    right:16px;
    background:rgba(255,255,255,0.07);
    border-radius:50%;
    width:48px;
    height:48px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:22px;
    cursor:pointer;
    box-shadow:0 20px 50px -10px rgba(0,0,0,0.5);
    z-index:5;
  }
  .footer {
    margin-top:auto;
    text-align:center;
    font-size:0.68rem;
    color: var(--muted);
  }
  .overlay {
    position:fixed;
    inset:0;
    background:rgba(15,17,26,0.95);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    z-index:100;
  }
  .card {
    background: var(--card);
    padding:22px 26px;
    border-radius:18px;
    max-width:480px;
    width:100%;
    position:relative;
    box-shadow: var(--shadow);
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .close-btn {
    position:absolute;
    top:10px;
    right:10px;
    background:rgba(255,255,255,0.07);
    border:none;
    width:32px;
    height:32px;
    border-radius:50%;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    color:#fff;
  }
  .confetti {
    position:absolute;
    inset:0;
    pointer-events:none;
    overflow:hidden;
  }
  .tag {
    background:rgba(255,255,255,0.08);
    padding:2px 8px;
    border-radius:999px;
    font-size:0.55rem;
    display:inline-block;
    margin-right:4px;
  }
  .mobile-hint {
    background:rgba(255,255,255,0.05);
    padding:6px 10px;
    border-radius:10px;
    font-size:0.65rem;
    display:flex;
    gap:6px;
    align-items:center;
  }
  @media (max-width:480px){
    h1{font-size:1.4rem;}
    button{font-size:0.95rem;}
    .info{font-size:0.7rem;}
  }
  @media (prefers-reduced-motion: reduce){
    *{animation:none !important; transition:none !important;}
  }
</style>
</head>
<body>
  <div class="app" aria-label="–ò–≥—Ä–∞ Baby Bump Defender">
    <header aria-label="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è">
      <div>
        <h1>üçº Baby Bump Defender</h1>
        <div class="small">–î–ª—è –±—É–¥—É—â–µ–π –º–∞–º—ã ‚Äî –ø—É—Å—Ç—å –º–∞–ª—ã—à —É–ª—ã–±–∞–µ—Ç—Å—è</div>
      </div>
      <div class="name-section">
        <label for="playerNameInput">–ò–º—è:</label>
        <input id="playerNameInput" aria-label="–ò–º—è –±—É–¥—É—â–µ–π –º–∞–º—ã" placeholder="–õ—é–±–∏–º–∞—è" maxlength="20" />
      </div>
    </header>

    <!-- –ø–æ–¥—Å–∫–∞–∑–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="mobile-hint" aria-live="polite">
      <div class="tag">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div> –¢—Ä–æ–≥–∞–π –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –ø—É–∑–∏–∫–æ –≤–Ω–∏–∑—É, —á—Ç–æ–±—ã –ª–æ–≤–∏—Ç—å ‚ù§Ô∏è –∏ –∏–∑–±–µ–≥–∞—Ç—å üí£. –©—ë–ª–∫–Ω–∏ –ø–æ –ø—É–∑–∏–∫—É 5 —Ä–∞–∑ ‚Äî –ø–∞—Å—Ö–∞–ª–∫–∞. –ö–Ω–æ–ø–∫–∞ ¬´–°–µ–∫—Ä–µ—Ç ‚ù§Ô∏è¬ª ‚Äî —Ç—ë–ø–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    </div>

    <div id="game-area" aria-label="–ò–≥—Ä–æ–≤–æ–µ –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –∏ —Å—Ç–∞—Ç—É—Å">
      <canvas id="game" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ: –ø—É–∑–∏–∫–æ –ª–æ–≤–∏—Ç —Ö–æ—Ä–æ—à–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏"></canvas>

      <div class="info" aria-label="–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç—É—Å–∞">
        <div aria-label="–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ">
          <div class="small">–ü—Ä–∏–≤–µ—Ç,</div>
          <strong id="displayName">–õ—é–±–∏–º–∞—è</strong>
        </div>
        <div aria-label="–°—á–∞—Å—Ç—å–µ –º–∞–ª—ã—à–∞">
          <div class="small">–°—á–∞—Å—Ç—å–µ –º–∞–ª—ã—à–∞:</div>
          <strong id="happinessDisplay">50%</strong>
        </div>
        <div aria-label="–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å">
          <div class="small">–£—Ä–æ–≤–µ–Ω—å:</div>
          <strong id="levelDisplay">1</strong>
        </div>
        <div aria-label="–õ—É—á—à–∏–π –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å">
          <div class="small">–õ—É—á—à–∏–π:</div>
          <strong id="bestDisplay">1</strong>
        </div>
      </div>

      <div class="message-box" id="message" aria-live="polite">
        –°–æ–±–∏—Ä–∞–π —Ö–æ—Ä–æ—à–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏ –∏ –∏–∑–±–µ–≥–∞–π —Å—Ç—Ä–µ—Å—Å–∞! üíñüí£
      </div>
    </div>

    <div class="controls" aria-label="–£–ø—Ä–∞–≤–ª—è—é—â–∏–µ –∫–Ω–æ–ø–∫–∏">
      <button id="startBtn" aria-label="–ù–∞—á–∞—Ç—å –∏–≥—Ä—É">–ò–≥—Ä–∞—Ç—å</button>
      <button id="resetBtn" class="secondary" aria-label="–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å">–°–±—Ä–æ—Å–∏—Ç—å</button>
      <button id="loveBtn" aria-label="–ü–æ–∫–∞–∑–∞—Ç—å —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">–°–µ–∫—Ä–µ—Ç ‚ù§Ô∏è</button>
    </div>

    <div class="footer">
      –°–∫–æ—Ä–æ –º–∞–ª—ã—à ‚Äî –∞ –ø–æ–∫–∞: –∑–∞—Ä—è–¥ –ø–æ–∑–∏—Ç–∏–≤–∞ –æ—Ç —Ç–µ–±—è –∏ –∏–≥—Ä—ã!<br />
      (–ò–º—è –∏ –ª—É—á—à–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ)
    </div>
  </div>

  <!-- –°–µ–∫—Ä–µ—Ç–Ω–æ–µ –æ–∫–Ω–æ -->
  <div id="overlay" style="display:none;" aria-hidden="true">
    <div class="overlay" role="dialog" aria-label="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ –ø–æ—Å–ª–∞–Ω–∏–µ">
      <div class="card">
        <button class="close-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
        <h2>–¢–µ–±–µ –æ—Ç –≠–¥–≤–∞—Ä–¥–∞</h2>
        <p>–¢—ã —É–∂–µ —Å—É–ø–µ—Ä–≥–µ—Ä–æ–∏–Ω—è ‚Äî —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è –º–∞–ª–µ–Ω—å–∫–∏–π –º–∏—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ª—é–±–∏—Ç—å —Ç–µ–±—è –±–µ–∑–º–µ—Ä–Ω–æ. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Ç—ã —Ç–∞–∫–∞—è. üíõ</p>
        <p>–≠—Ç–æ—Ç –º–∞–ª—ã—à —É–∂–µ —á—É–≤—Å—Ç–≤—É–µ—Ç —Ç–≤–æ—é –∑–∞–±–æ—Ç—É. –ê —è —Å—á–∏—Ç–∞—é –¥–Ω–∏ –∏ —É–ª—ã–±–∞—é—Å—å, –∫–æ–≥–¥–∞ –¥—É–º–∞—é –æ –≤–∞—Å –¥–≤–æ–∏—Ö.</p>
        <p style="margin-top:6px;">–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å —â—ë–ª–∫–Ω—É—Ç—å –ø–æ –ø—É–∑–∏–∫—É 5 —Ä–∞–∑ ‚Äî —Ç–∞–º –µ—â—ë –æ–¥–Ω–∞ –º–∞–ª–µ–Ω—å–∫–∞—è —à—É—Ç–∫–∞ –≤–Ω—É—Ç—Ä–∏. üòâ</p>
        <div style="display:flex;gap:10px;margin-top:8px;">
          <button id="closeLove" style="flex:1;">–û–±–Ω—è—Ç—å ü§ó</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–º–æ—â–∏ -->
  <div class="help-badge" aria-label="–°–ø—Ä–∞–≤–∫–∞" id="helpBtn" title="–ö–∞–∫ –∏–≥—Ä–∞—Ç—å?">?</div>

  <!-- –°–ø—Ä–∞–≤–æ—á–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ -->
  <div id="helpOverlay" style="display:none;">
    <div class="overlay" role="dialog" aria-label="–°–ø—Ä–∞–≤–∫–∞ –∏–≥—Ä—ã">
      <div class="card">
        <button class="close-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å —Å–ø—Ä–∞–≤–∫—É">&times;</button>
        <h2>–ö–∞–∫ –∏–≥—Ä–∞—Ç—å</h2>
        <p>–¶–µ–ª—å: —Å–æ–±—Ä–∞—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ <strong>‚ù§Ô∏è —Ö–æ—Ä–æ—à–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏</strong> –∏ –∏–∑–±–µ–≥–∞—Ç—å <strong>üí£ —Å—Ç—Ä–µ—Å—Å–æ–≤</strong>, —á—Ç–æ–±—ã –ø–æ–¥–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞–ª—ã—à—É.</p>
        <ul>
          <li>–¢—Ä–æ–≥–∞–π/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π –ø—É–∑–∏–∫–æ –≤–Ω–∏–∑—É ‚Äî –æ–Ω–æ –¥–≤–∏–∂–µ—Ç—Å—è –∑–∞ –ø–∞–ª—å—Ü–µ–º –∏–ª–∏ –º—ã—à—å—é.</li>
          <li>–°–æ–±–∏—Ä–∞–π —Å–µ—Ä–¥–µ—á–∫–∏, –∏–∑–±–µ–≥–∞–π –±–æ–º–± ‚Äî —Ä–∞—Å—Ç—ë—Ç —É—Ä–æ–≤–µ–Ω—å –∏ —Å—á–∞—Å—Ç—å–µ.</li>
          <li>–ö–æ–≥–¥–∞ —Å—á–∞—Å—Ç—å–µ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç 100%, —É—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–∞–µ—Ç—Å—è.</li>
          <li>–ï—Å–ª–∏ —Å—á–∞—Å—Ç—å–µ –ø–∞–¥–∞–µ—Ç –¥–æ 0 ‚Äî –∏–≥—Ä–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è. –ú–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.</li>
          <li>–ü–∞—Å—Ö–∞–ª–∫–∞: —â—ë–ª–∫–Ω–∏ –ø–æ –ø—É–∑–∏–∫—É 5 —Ä–∞–∑ –ø–æ–¥—Ä—è–¥ ‚Äî –ø–æ—è–≤–∏—Ç—Å—è —Ç—ë–ø–ª–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.</li>
        </ul>
        <p>–ò–º—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –õ—É—á—à–∏–π —É—Ä–æ–≤–µ–Ω—å —Ç–æ–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</p>
        <div style="display:flex;gap:10px;margin-top:6px;">
          <button id="closeHelp" style="flex:1;">–ü–æ–Ω—è—Ç–Ω–æ üëç</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // === –≠–ª–µ–º–µ–Ω—Ç—ã DOM ===
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const nameInput = document.getElementById("playerNameInput");
    const displayNameEl = document.getElementById("displayName");
    const happinessEl = document.getElementById("happinessDisplay");
    const levelEl = document.getElementById("levelDisplay");
    const bestEl = document.getElementById("bestDisplay");
    const messageEl = document.getElementById("message");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const loveBtn = document.getElementById("loveBtn");
    const overlay = document.getElementById("overlay");
    const closeLove = document.getElementById("closeLove");
    const closeX = document.querySelectorAll(".close-btn");
    const helpBtn = document.getElementById("helpBtn");
    const helpOverlay = document.getElementById("helpOverlay");
    const closeHelp = document.getElementById("closeHelp");

    // === –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ ===
    const STORAGE_KEY = "baby_bump_defender_state_v2";
    let state = { bestLevel:1, name:"–õ—é–±–∏–º–∞—è" };
    try {
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
      if(saved && typeof saved === "object"){
        if(typeof saved.bestLevel === "number") state.bestLevel = saved.bestLevel;
        if(typeof saved.name === "string" && saved.name.trim()) state.name = saved.name.trim();
      }
    } catch(e){ /* –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º */ }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
    nameInput.value = state.name;
    displayNameEl.textContent = state.name;
    bestEl.textContent = state.bestLevel;

    // === –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ===
    let gameWidth = 0, gameHeight = 0;
    const player = { x:0, y:0, w:120, h:28, targetX:0 };
    let falling = [];
    let lastSpawn = 0;
    let spawnInterval = 1000;
    let happiness = 50;
    let level = 1;
    let running = false;
    let gameOver = false;
    let difficultyTimer = Date.now();
    let humorTimer = Date.now();
    let flash = { color:null, alpha:0 };
    let bellyClicks = 0;
    let lastBellyClick = 0;

    // === Resize (—Å –¥–µ–±–∞—É–Ω—Å–æ–º) ===
    let resizeTimeout = null;
    function resize(){
      const ratio = window.devicePixelRatio || 1;
      const maxW = Math.min(window.innerWidth - 24, 480);
      canvas.width = Math.floor(maxW * ratio);
      canvas.height = Math.floor((maxW * (16/9)) * ratio);
      gameWidth = canvas.width / ratio;
      gameHeight = canvas.height / ratio;
      canvas.style.height = (gameHeight) + "px";
      player.w = Math.max(80, Math.min(160, gameWidth * 0.28));
      player.y = gameHeight - 36;
      player.targetX = Math.min(Math.max(player.x, 0), gameWidth - player.w);
    }
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(resize, 60);
    });
    resize();

    // === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ===
    function saveState(){
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          bestLevel: state.bestLevel,
          name: state.name
        }));
      } catch(e){}
    }
    function showTempMessage(txt, duration=2500){
      messageEl.textContent = txt;
      clearTimeout(messageEl._timeout);
      messageEl._timeout = setTimeout(()=>{
        if(!gameOver){
          messageEl.textContent = "–°–æ–±–∏—Ä–∞–π —Ö–æ—Ä–æ—à–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏ –∏ –∏–∑–±–µ–≥–∞–π —Å—Ç—Ä–µ—Å—Å–∞! üíñüí£";
        }
      }, duration);
    }

    // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞–¥–∞—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ ===
    function spawnItem(){
      if(falling.length > 120) return; // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –º–∞—Å—Å—É
      const type = Math.random() < 0.6 ? "heart" : "stress";
      const size = type === "heart" ? 34 : 38;
      const x = Math.random() * (gameWidth - size - 6) + 3;
      const baseSpeed = 1 + level * 0.25;
      const speed = baseSpeed + Math.random()*0.6;
      falling.push({
        x, y: -size,
        size,
        type,
        speed,
        wobble: Math.random()*Math.PI*2,
        amplitude: 6 + Math.random()*6
      });
    }

    // === –°–±—Ä–æ—Å/—Å—Ç–∞—Ä—Ç ===
    function resetGame(){
      falling = [];
      happiness = 50;
      level = 1;
      spawnInterval = 1000;
      lastSpawn = Date.now();
      running = false;
      gameOver = false;
      updateUI();
      showTempMessage("–ù–∞–∂–º–∏ ¬´–ò–≥—Ä–∞—Ç—å¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å. üë∂üíñ");
    }
    function levelUp(){
      level++;
      if(level > state.bestLevel){
        state.bestLevel = level;
        bestEl.textContent = state.bestLevel;
        saveState();
      }
      showConfetti();
      showTempMessage(`–£—Ä–∞! –£—Ä–æ–≤–µ–Ω—å ${level}! –ú–∞–ª—ã—à –ø–æ–¥–Ω–∏–º–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ! üéâ`, 3300);
      spawnInterval = Math.max(350, 1000 - (level-1)*90);
    }
    function gameLost(){
      running = false;
      gameOver = true;
      showTempMessage("–û–π! –ú–∞–ª—ã—à —Ä–∞–∑–æ–∑–ª–∏–ª—Å—è –æ—Ç —Å—Ç—Ä–µ—Å—Å–∞. –°–¥–µ–ª–∞–π –ø–∞—É–∑—É, –≥–ª—É–±–æ–∫–æ –≤–¥–æ—Ö–Ω–∏. üå¨Ô∏è", 4500);
    }

    function updateUI(){
      happinessEl.textContent = Math.max(0, Math.min(100, Math.round(happiness))) + "%";
      levelEl.textContent = level;
      bestEl.textContent = state.bestLevel;
      displayNameEl.textContent = state.name || "–õ—é–±–∏–º–∞—è";
    }

    // === –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ ===
    function showConfetti(){
      const conf = document.createElement("div");
      conf.className = "confetti";
      document.body.appendChild(conf);
      const pieces = [];
      for(let i=0;i<50;i++){
        const el = document.createElement("div");
        el.textContent = ["üéà","‚ú®","üí´"][Math.floor(Math.random()*3)];
        el.style.position="absolute";
        el.style.fontSize=(12+Math.random()*16)+"px";
        el.style.left = (50 + (Math.random()-0.5)*120) + "%";
        el.style.top = "-10px";
        el.style.opacity=1;
        el.style.pointerEvents="none";
        conf.appendChild(el);
        const speedY = 1 + Math.random()*2;
        const drift = (Math.random()-0.5)*1.2;
        pieces.push({el,speedY,drift});
      }
      let t=0;
      const anim = ()=>{
        t++;
        pieces.forEach(p=>{
          const top = parseFloat(p.el.style.top);
          const left = parseFloat(p.el.style.left);
          p.el.style.top = top + p.speedY + "px";
          p.el.style.left = left + p.drift + "px";
          p.el.style.opacity = Math.max(0, 1 - t/100);
        });
        if(t < 100){
          requestAnimationFrame(anim);
        } else {
          conf.remove();
        }
      };
      requestAnimationFrame(anim);
    }

    // === –¶–∏–∫–ª –∏–≥—Ä—ã ===
    function loop(){
      if(!running) return;
      const now = Date.now();

      if(now - lastSpawn > spawnInterval){
        spawnItem();
        lastSpawn = now;
      }
      if(now - difficultyTimer > 15000){
        difficultyTimer = now;
        if(spawnInterval > 400) spawnInterval -= 35;
      }
      if(now - humorTimer > 12000){
        humorTimer = now;
        const jokes = [
          "–ú–∞–ª—ã—à —à–µ–ø—á–µ—Ç: ¬´–µ—â—ë –æ–¥–Ω–æ —Å–µ—Ä–¥–µ—á–∫–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞¬ª üíï",
          "–°—Ç—Ä–µ—Å—Å –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–±—Ä–∞—Ç—å—Å—è ‚Äî –Ω–µ –ø—É—Å–∫–∞–π –µ–≥–æ! üö´",
          "–°—á–∞—Å—Ç—å–µ –º–∞–ª—ã—à–∞ —Ä–∞—Å—Ç—ë—Ç, –∫–∞–∫ —Ç–≤–æ–∏ —Å—É–ø–µ—Ä—Å–∏–ª—ã üí™",
          "–ü—É–∑–∏–∫–æ –≥–æ–≤–æ—Ä–∏—Ç: ¬´–µ—â—ë —á—É—Ç—å-—á—É—Ç—å!¬ª üòÑ",
          "–°–æ–±–∏—Ä–∞–π –≤–∏–±—Ä–∞—Ü–∏–∏, –∫–∞–∫ –æ–±–Ω–∏–º–∞—à–∫–∏ ü§ó"
        ];
        showTempMessage(jokes[Math.floor(Math.random()*jokes.length)], 2200);
      }

      // –ø–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
      player.x += (player.targetX - player.x)*0.2;
      if(player.x < 0) player.x = 0;
      if(player.x + player.w > gameWidth) player.x = gameWidth - player.w;

      // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
      falling = falling.filter(o => {
        o.y += o.speed;
        o.wobble += 0.04;
        o.x += Math.sin(o.wobble) * 0.15;
        if(o.y > gameHeight + 60) return false;
        if(o.x + o.size > player.x &&
           o.x < player.x + player.w &&
           o.y + o.size > player.y &&
           o.y < player.y + player.h){
          if(o.type === "heart"){
            happiness = Math.min(100, happiness + 6 + Math.random()*4);
          } else {
            happiness -= 11 + Math.random()*5;
          }
          flash.color = o.type === "heart" ? "#55ff99" : "#ff5555";
          flash.alpha = 0.5;
          setTimeout(()=>{ flash.alpha = 0; }, 120);
          return false;
        }
        return true;
      });

      if(happiness >= 100){
        happiness = 50 + Math.random()*7;
        levelUp();
      } else if(happiness <= 0){
        happiness = 0;
        gameLost();
      }

      updateUI();
      draw();
      requestAnimationFrame(loop);
    }

    // === –†–∏—Å–æ–≤–∞–Ω–∏–µ ===
    function draw(){
      const ratio = window.devicePixelRatio || 1;
      ctx.save();
      ctx.scale(ratio, ratio);
      // —Ñ–æ–Ω
      const grad = ctx.createLinearGradient(0,0,0,gameHeight);
      grad.addColorStop(0, "#1f233c");
      grad.addColorStop(1, "#0f111a");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,gameWidth,gameHeight);

      // –ø–∞–¥–∞—é—â–∏–µ
      falling.forEach(o => {
        ctx.save();
        ctx.translate(o.x + o.size/2, o.y + o.size/2);
        ctx.font = o.size + "px system-ui, apple-system";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        if(o.type === "heart"){
          ctx.fillText("‚ù§Ô∏è", 0, 0);
        } else {
          ctx.fillText("üí£", 0, 0);
        }
        ctx.restore();
      });

      // –∏–≥—Ä–æ–∫ (–ø—É–∑–∏–∫–æ)
      ctx.save();
      // —Ç–µ–Ω—å
      ctx.fillStyle = "rgba(255,255,255,0.04)";
      roundRect(ctx, player.x -4, player.y +4, player.w +8, player.h +8, 12);
      ctx.fill();
      // –ø—É–∑–∏–∫–æ
      ctx.fillStyle = "#ff9f43";
      roundRect(ctx, player.x, player.y, player.w, player.h, 12);
      ctx.fill();
      ctx.font = "16px system-ui";
      ctx.fillStyle = "#fff";
      ctx.textAlign="center";
      ctx.textBaseline="middle";
      ctx.fillText("ü§∞", player.x + player.w/2, player.y + player.h/2 -1);
      ctx.restore();

      // —Ñ–ª—ç—à —ç—Ñ—Ñ–µ–∫—Ç
      if(flash.alpha > 0){
        ctx.fillStyle = flash.color;
        ctx.globalAlpha = flash.alpha;
        ctx.fillRect(0,0,gameWidth,gameHeight);
        ctx.globalAlpha = 1;
      }

      // –ø–∞–Ω–µ–ª—å —Å—á–∞—Å—Ç—å—è
      const barW = gameWidth * 0.78;
      const barH = 14;
      const barX = (gameWidth - barW)/2;
      const barY = 10;
      ctx.lineWidth=0;
      ctx.fillStyle = "#1f2135";
      roundRect(ctx, barX, barY, barW, barH, 8);
      ctx.fill();
      const fillW = (happiness/100)*barW;
      const grad2 = ctx.createLinearGradient(barX,0,barX+barW,0);
      grad2.addColorStop(0, "#55ff99");
      grad2.addColorStop(1, "#ffeb3b");
      ctx.fillStyle = grad2;
      roundRect(ctx, barX, barY, fillW, barH, 8);
      ctx.fill();
      ctx.strokeStyle = "#444b9b";
      ctx.lineWidth=1;
      roundRect(ctx, barX, barY, barW, barH, 8);
      ctx.stroke();
      ctx.font = "12px system-ui";
      ctx.fillStyle = "#fff";
      ctx.textAlign="center";
      ctx.fillText("–°—á–∞—Å—Ç—å–µ –º–∞–ª—ã—à–∞", barX + barW/2, barY + barH + 14);

      ctx.restore();
    }

    // –æ–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
    function roundRect(ctx,x,y,w,h,r){
      if(typeof r === "number") r = {tl:r,tr:r,br:r,bl:r};
      ctx.beginPath();
      ctx.moveTo(x + r.tl, y);
      ctx.lineTo(x + w - r.tr, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
      ctx.lineTo(x + w, y + h - r.br);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
      ctx.lineTo(x + r.bl, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
      ctx.lineTo(x, y + r.tl);
      ctx.quadraticCurveTo(x, y, x + r.tl, y);
      ctx.closePath();
    }

    // === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ===
    function pointerMove(e){
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const x = clientX - rect.left;
      const scale = gameWidth / rect.width;
      player.targetX = Math.min(Math.max(x * scale - player.w/2, 0), gameWidth - player.w);
    }
    canvas.addEventListener("pointerdown", pointerMove, {passive:true});
    canvas.addEventListener("pointermove", pointerMove, {passive:true});
    canvas.addEventListener("touchstart", pointerMove, {passive:true});
    canvas.addEventListener("touchmove", pointerMove, {passive:true});

    // –ø–∞—Å—Ö–∞–ª–∫–∞: –∫–ª–∏–∫–∏ –ø–æ –ø—É–∑–∏–∫—É
    canvas.addEventListener("click", e => {
      const rect = canvas.getBoundingClientRect();
      const scale = gameWidth / rect.width;
      const x = (e.clientX - rect.left)*scale;
      const y = (e.clientY - rect.top)*(gameHeight / rect.height);
      const now = Date.now();
      if(now - lastBellyClick > 1000) bellyClicks = 0;
      lastBellyClick = now;
      if(x >= player.x && x <= player.x + player.w && y >= player.y && y <= player.y + player.h){
        bellyClicks++;
        if(bellyClicks === 5){
          showTempMessage("–ü—É–∑–∏–∫ —á—É–≤—Å—Ç–≤—É–µ—Ç –ª—é–±–æ–≤—å! üíú –°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Ç—ã —Ç—É—Ç.", 3000);
          bellyClicks = 0;
        }
      }
    });

    // === –ö–Ω–æ–ø–∫–∏ ===
    function startGame(){
      if(running) return;
      running = true;
      gameOver = false;
      falling = [];
      happiness = 50;
      level = 1;
      spawnInterval = 1000;
      lastSpawn = Date.now();
      difficultyTimer = Date.now();
      humorTimer = Date.now();
      updateUI();
      showTempMessage("–ü–æ–µ—Ö–∞–ª–∏! –õ–æ–≤–∏ —Ö–æ—Ä–æ—à–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏ –∏ –±–µ—Ä–µ–≥–∏ –º–∞–ª—ã—à–∞. üõ°Ô∏è");
      requestAnimationFrame(loop);
    }
    function resetAll(){
      state.bestLevel = 1;
      saveState();
      resetGame();
      updateUI();
    }

    startBtn.addEventListener("click", startGame);
    resetBtn.addEventListener("click", resetAll);
    loveBtn.addEventListener("click", ()=> {
      overlay.style.display="block";
      overlay.setAttribute("aria-hidden","false");
    });
    closeLove.addEventListener("click", ()=> {
      overlay.style.display="none";
      overlay.setAttribute("aria-hidden","true");
    });
    closeX.forEach(b=> b.addEventListener("click", ()=> {
      helpOverlay.style.display = "none";
      overlay.style.display="none";
      helpOverlay.setAttribute("aria-hidden","true");
      overlay.setAttribute("aria-hidden","true");
    }));

    nameInput.addEventListener("input", e => {
      const v = e.target.value.trim();
      state.name = v || "–õ—é–±–∏–º–∞—è";
      displayNameEl.textContent = state.name;
      saveState();
    });

    helpBtn.addEventListener("click", ()=> {
      helpOverlay.style.display = "block";
      helpOverlay.setAttribute("aria-hidden","false");
    });
    closeHelp.addEventListener("click", ()=> {
      helpOverlay.style.display = "none";
      helpOverlay.setAttribute("aria-hidden","true");
    });

    helpOverlay.addEventListener("click", e => {
      if(e.target === helpOverlay) {
        helpOverlay.style.display="none";
        helpOverlay.setAttribute("aria-hidden","true");
      }
    });
    overlay.addEventListener("click", e => {
      if(e.target === overlay){
        overlay.style.display="none";
        overlay.setAttribute("aria-hidden","true");
      }
    });

    // === –°—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ===
    resetGame();

    // === –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ —É—Ö–æ–¥–µ ===
    window.addEventListener("beforeunload", saveState);
  })();
  </script>
</body>
</html>
