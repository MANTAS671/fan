<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no" />
<title>Baby Bump Defender</title>
<style>
  :root {
    --bg:#0f111a;
    --card:#1f2135;
    --radius:16px;
    --shadow:0 20px 40px -10px rgba(0,0,0,0.5);
    --accent:#ff6b6b;
    --muted:#888bb3;
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    background: linear-gradient(135deg,#0f111a 0%,#1f2135 80%);
    min-height:100vh;
    color:#e3e8ff;
    -webkit-font-smoothing:antialiased;
  }
  .container{
    max-width:900px;
    margin:0 auto;
    padding:12px 16px 40px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  header{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:10px;
    justify-content:space-between;
  }
  h1{
    margin:0;
    font-size:1.6rem;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .name-input{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    align-items:center;
    font-size:0.9rem;
  }
  .name-input input{
    padding:8px 12px;
    border-radius:999px;
    border:none;
    outline:none;
    font-size:1rem;
    min-width:140px;
    background:#1f2135;
    color:#fff;
    box-shadow:inset 0 0 10px rgba(255,255,255,0.03);
  }
  #game-area{
    position:relative;
    background:rgba(255,255,255,0.03);
    border-radius:16px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    gap:8px;
    padding:12px;
  }
  canvas{
    width:100%;
    aspect-ratio:9/16;
    background:linear-gradient(135deg,#1f233c 0%,#0f111a 90%);
    border-radius:12px;
    touch-action:none;
    display:block;
  }
  .info{
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(120px,1fr));
    gap:8px;
    font-size:0.85rem;
    margin-top:4px;
  }
  .info div{
    background:rgba(255,255,255,0.04);
    padding:8px 12px;
    border-radius:10px;
    display:flex;
    align-items:center;
    gap:6px;
    flex-wrap:wrap;
  }
  .score{
    font-weight:600;
  }
  .messages{
    margin-top:4px;
    background:rgba(255,255,255,0.02);
    padding:10px 14px;
    border-radius:10px;
    font-size:0.95rem;
    min-height:48px;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    overflow:hidden;
  }
  .controls{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:4px;
  }
  button{
    padding:12px 18px;
    border:none;
    cursor:pointer;
    border-radius:999px;
    font-weight:600;
    font-size:1rem;
    background:linear-gradient(135deg,var(--accent) 0%,#ff9f43 80%);
    color:#fff;
    flex:1;
    min-width:120px;
    position:relative;
    overflow:hidden;
    transition:transform .2s;
    box-shadow:0 12px 30px -5px rgba(255,107,107,0.6);
  }
  button:active{transform:scale(.95);}
  .secondary{
    background:rgba(255,255,255,0.07);
    color:#e3e8ff;
    box-shadow:0 12px 30px -5px rgba(0,0,0,0.3);
  }
  footer{
    margin-top:auto;
    text-align:center;
    font-size:0.8rem;
    color:var(--muted);
  }
  .overlay{
    position:fixed;
    inset:0;
    background:rgba(15,17,26,0.95);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    z-index:10;
  }
  .card{
    background: var(--card);
    padding:24px 30px;
    border-radius:20px;
    max-width:500px;
    width:100%;
    position:relative;
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    gap:14px;
  }
  .close-btn{
    position:absolute;
    top:14px;
    right:14px;
    background:rgba(255,255,255,0.07);
    border:none;
    width:32px;
    height:32px;
    border-radius:50%;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:18px;
    color:#fff;
  }
  .confetti{
    position:absolute;
    inset:0;
    pointer-events:none;
    overflow:hidden;
  }
  .heart{
    animation:beat .8s ease-in-out infinite;
    display:inline-block;
  }
  @keyframes beat{
    0%,100%{transform:scale(1);}
    50%{transform:scale(1.15);}
  }
  .small{
    font-size:0.78rem;
  }
</style>
</head>
<body>
  <div class="container" aria-label="Baby Bump Defender –∏–≥—Ä–∞">
    <header>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <h1>üçº Baby Bump Defender</h1>
        <div class="small">(–¥–ª—è –±—É–¥—É—â–µ–π –º–∞–º—ã ‚Äî –ø—É—Å—Ç—å –º–∞–ª—ã—à —É–ª—ã–±–∞–µ—Ç—Å—è)</div>
      </div>
      <div class="name-input">
        <label for="playerNameInput">–ò–º—è:</label>
        <input id="playerNameInput" placeholder="–õ—é–±–∏–º–∞—è" maxlength="20" />
      </div>
    </header>

    <div id="game-area">
      <canvas id="game" aria-label="–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ"></canvas>
      <div class="info" aria-live="polite">
        <div>–ü—Ä–∏–≤–µ—Ç, <strong id="displayName">–õ—é–±–∏–º–∞—è</strong>! üòä</div>
        <div>–°—á–∞—Å—Ç—å–µ –º–∞–ª—ã—à–∞: <strong id="happinessDisplay">50</strong>%</div>
        <div>–£—Ä–æ–≤–µ–Ω—å: <strong id="levelDisplay">1</strong></div>
        <div>–õ—É—á—à–∏–π —É—Ä–æ–≤–µ–Ω—å: <strong id="bestDisplay">1</strong></div>
      </div>
      <div class="messages" id="message" aria-live="polite">
        –°–æ–±–∏—Ä–∞–π —Ö–æ—Ä–æ—à–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏ –∏ –∏–∑–±–µ–≥–∞–π —Å—Ç—Ä–µ—Å—Å–∞! üíñüí£
      </div>
    </div>

    <div class="controls">
      <button id="startBtn">–ò–≥—Ä–∞—Ç—å</button>
      <button id="resetBtn" class="secondary">–°–±—Ä–æ—Å–∏—Ç—å</button>
      <button id="loveBtn">–°–µ–∫—Ä–µ—Ç ‚ù§Ô∏è</button>
    </div>

    <footer>–°–∫–æ—Ä–æ –º–∞–ª—ã—à ‚Äî –∞ –ø–æ–∫–∞: –∑–∞—Ä—è–¥ –ø–æ–∑–∏—Ç–∏–≤–∞ –æ—Ç —Ç–µ–±—è –∏ –∏–≥—Ä—ã!</footer>
  </div>

  <!-- –°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
  <div id="overlay" style="display:none;">
    <div class="overlay" role="dialog" aria-label="–°–µ–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ">
      <div class="card">
        <button class="close-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å">&times;</button>
        <h2>–¢–µ–±–µ –æ—Ç –≠–¥–≤–∞—Ä–¥–∞</h2>
        <p>–¢—ã —É–∂–µ —Å—É–ø–µ—Ä–≥–µ—Ä–æ–∏–Ω—è ‚Äî —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è –º–∞–ª–µ–Ω—å–∫–∏–π –º–∏—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ª—é–±–∏—Ç—å —Ç–µ–±—è –±–µ–∑–º–µ—Ä–Ω–æ. –°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Ç—ã —Ç–∞–∫–∞—è. üíõ</p>
        <p>–≠—Ç–æ—Ç –º–∞–ª—ã—à —É–∂–µ —á—É–≤—Å—Ç–≤—É–µ—Ç —Ç–≤–æ—é –∑–∞–±–æ—Ç—É. –ê —è —Å—á–∏—Ç–∞—é –¥–Ω–∏ –∏ —É–ª—ã–±–∞—é—Å—å, –∫–æ–≥–¥–∞ –¥—É–º–∞—é –æ –≤–∞—Å –¥–≤–æ–∏—Ö.</p>
        <p style="margin-top:10px;">–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –º–æ–∂–µ—à—å —â—ë–ª–∫–Ω—É—Ç—å –ø–æ –ø—É–∑–∏–∫—É –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ ‚Äî —Ç–∞–º –µ—â—ë –æ–¥–Ω–∞ –º–∞–ª–µ–Ω—å–∫–∞—è —à—É—Ç–∫–∞ –≤–Ω—É—Ç—Ä–∏. üòâ</p>
        <div style="display:flex;gap:10px;margin-top:6px;">
          <button id="closeLove" style="flex:1;">–û–±–Ω—è—Ç—å ü§ó</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ======
  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const messageEl = document.getElementById("message");
  const displayNameEl = document.getElementById("displayName");
  const happinessEl = document.getElementById("happinessDisplay");
  const levelEl = document.getElementById("levelDisplay");
  const bestEl = document.getElementById("bestDisplay");
  const nameInput = document.getElementById("playerNameInput");
  const startBtn = document.getElementById("startBtn");
  const resetBtn = document.getElementById("resetBtn");
  const loveBtn = document.getElementById("loveBtn");
  const overlay = document.getElementById("overlay");
  const closeLove = document.getElementById("closeLove");
  const closeX = document.querySelector(".close-btn");

  // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
  const STORAGE_KEY = "baby_bump_defender_state";
  let state = {
    bestLevel: 1,
    name: "–õ—é–±–∏–º–∞—è"
  };
  function loadState(){
    try {
      const s = JSON.parse(localStorage.getItem(STORAGE_KEY));
      if(s){
        state = {...state, ...s};
      }
    } catch(e){}
    nameInput.value = state.name;
    displayNameEl.textContent = state.name;
    bestEl.textContent = state.bestLevel;
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      bestLevel: state.bestLevel,
      name: state.name
    }));
  }

  loadState();

  // ====== –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ======
  let gameWidth, gameHeight;
  let player = { x: 0, y: 0, w: 120, h: 24, targetX: 0 };
  let falling = []; // –æ–±—ä–µ–∫—Ç—ã
  let lastSpawn = 0;
  let spawnInterval = 1000;
  let happiness = 50; // 0..100
  let level = 1;
  let running = false;
  let highScoreLevel = state.bestLevel;
  let gameOver = false;
  let spawnTimerId = null;
  let difficultyTimer = 0;
  let humorTimer = 0;

  // –ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞
  function resize(){
    canvas.width = Math.floor(window.innerWidth * 0.9 * devicePixelRatio);
    canvas.height = Math.floor((window.innerWidth * 0.9 * (16/9)) * devicePixelRatio);
    gameWidth = canvas.width / devicePixelRatio;
    gameHeight = canvas.height / devicePixelRatio;
    canvas.style.height = (gameHeight / devicePixelRatio) + "px";
    player.w = Math.max(80, Math.min(160, gameWidth * 0.25));
    player.y = gameHeight - 40;
    player.x = gameWidth / 2 - player.w / 2;
    player.targetX = player.x;
  }
  window.addEventListener("resize", resize);
  resize();

  // ====== –°–æ–±—ã—Ç–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ======
  function pointerMove(e){
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    player.targetX = Math.min(gameWidth - player.w, Math.max(0, x / (rect.width / gameWidth) - player.w/2));
  }
  canvas.addEventListener("pointerdown", pointerMove);
  canvas.addEventListener("pointermove", pointerMove);
  canvas.addEventListener("touchstart", pointerMove);
  canvas.addEventListener("touchmove", pointerMove);

  // –©—ë–ª–∫ –ø–æ –ø—É–∑–∏–∫—É ‚Äî –ø–∞—Å—Ö–∞–ª–∫–∞
  let bellyClicks = 0;
  let lastBellyClick = 0;
  function checkBellyClick(x,y){
    const now=Date.now();
    if(now - lastBellyClick > 1000) bellyClicks=0;
    lastBellyClick=now;
    // –µ—Å–ª–∏ —Ç–æ—á–∫–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∏–≥—Ä–æ–∫–∞
    if(x >= player.x && x <= player.x+player.w && y >= player.y && y <= player.y+player.h){
      bellyClicks++;
      if(bellyClicks === 5){
        showTempMessage("–ü—É–∑–∏–∫ —á—É–≤—Å—Ç–≤—É–µ—Ç –ª—é–±–æ–≤—å! üíú –°–ø–∞—Å–∏–±–æ, —á—Ç–æ —Ç—ã —Ç—É—Ç.", 3000);
        bellyClicks=0;
      }
    }
  }
  canvas.addEventListener("click", e => {
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left) / (rect.width / gameWidth);
    const y = (e.clientY - rect.top) / (rect.height / gameHeight);
    checkBellyClick(x,y);
  });

  // ====== –û–±—ä–µ–∫—Ç—ã (–ø–∞–¥–∞—é—â–∏–µ) ======
  function spawnItem(){
    // —Ç–∏–ø: heart –∏–ª–∏ stress
    const type = Math.random() < 0.6 ? "heart" : "stress";
    const size = type === "heart" ? 36 : 40;
    const x = Math.random() * (gameWidth - size - 10) + 5;
    const speed = 1 + level * 0.3 + Math.random() * 0.7; // —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å —É—Ä–æ–≤–Ω–µ–º
    falling.push({
      x, y: -size,
      size,
      type,
      speed,
      wobble: Math.random()*Math.PI*2,
      amplitude: 10 + Math.random()*10
    });
  }

  function resetGame(){
    falling = [];
    happiness = 50;
    level = 1;
    spawnInterval = 1000;
    lastSpawn = 0;
    running = false;
    gameOver = false;
    updateUI();
    showTempMessage("–ù–∞–∂–º–∏ ¬´–ò–≥—Ä–∞—Ç—å¬ª, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å. üë∂üíñ");
  }

  function startGame(){
    if(running) return;
    running = true;
    gameOver = false;
    falling = [];
    happiness = 50;
    level = 1;
    spawnInterval = 1000;
    lastSpawn = Date.now();
    difficultyTimer = Date.now();
    humorTimer = Date.now();
    updateUI();
    showTempMessage("–ü–æ–µ—Ö–∞–ª–∏! –õ–æ–≤–∏ —Ö–æ—Ä–æ—à–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏ –∏ –±–µ—Ä–µ–≥–∏ –º–∞–ª—ã—à–∞. üõ°Ô∏è");
    requestAnimationFrame(loop);
  }

  function updateUI(){
    happinessEl.textContent = Math.max(0, Math.min(100, Math.round(happiness)));
    levelEl.textContent = level;
    bestEl.textContent = state.bestLevel;
    displayNameEl.textContent = state.name || "–õ—é–±–∏–º–∞—è";
  }

  function showTempMessage(txt,duration=2500){
    messageEl.textContent = txt;
    clearTimeout(messageEl._timeout);
    messageEl._timeout = setTimeout(()=>{
      if(!gameOver){
        messageEl.textContent = "–°–æ–±–∏—Ä–∞–π —Ö–æ—Ä–æ—à–∏–µ –≤–∏–±—Ä–∞—Ü–∏–∏ –∏ –∏–∑–±–µ–≥–∞–π —Å—Ç—Ä–µ—Å—Å–∞! üíñüí£";
      }
    },duration);
  }

  function levelUp(){
    level++;
    if(level > state.bestLevel){
      state.bestLevel = level;
      saveState();
    }
    showConfetti();
    showTempMessage(`–£—Ä–∞! –£—Ä–æ–≤–µ–Ω—å ${level}! –ú–∞–ª—ã—à –ø–æ–¥–Ω–∏–º–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ! üéâ`, 3500);
    // —á—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è, —á—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ –ø–∞–¥–∞–µ—Ç
    spawnInterval = Math.max(350, 1000 - (level-1)*100);
  }

  function gameLost(){
    running = false;
    gameOver = true;
    showTempMessage("–û–π! –ú–∞–ª—ã—à —Ä–∞–∑–æ–∑–ª–∏–ª—Å—è –æ—Ç —Å—Ç—Ä–µ—Å—Å–∞. –°–¥–µ–ª–∞–π –ø–∞—É–∑—É, –≥–ª—É–±–æ–∫–æ –≤–¥–æ—Ö–Ω–∏. üå¨Ô∏è", 5000);
  }

  // ====== –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ ======
  function showConfetti(){
    const conf = document.createElement("div");
    conf.className = "confetti";
    document.body.appendChild(conf);
    const pieces = [];
    for(let i=0;i<60;i++){
      const el = document.createElement("div");
      el.textContent = "üéà";
      el.style.position="absolute";
      el.style.fontSize=(12+Math.random()*18)+"px";
      el.style.left = (50 + (Math.random()-0.5)*100) + "%";
      el.style.top = "-10px";
      el.style.opacity=1;
      el.style.pointerEvents="none";
      conf.appendChild(el);
      const speedY = 1 + Math.random()*2;
      const drift = (Math.random()-0.5)*1.5;
      pieces.push({el,speedY,drift});
    }
    let t=0;
    const anim = ()=>{
      t++;
      pieces.forEach(p=>{
        const top = parseFloat(p.el.style.top);
        const left = parseFloat(p.el.style.left);
        p.el.style.top = top + p.speedY + "px";
        p.el.style.left = left + p.drift + "px";
        p.el.style.opacity = Math.max(0, 1 - t/100);
      });
      if(t < 100){
        requestAnimationFrame(anim);
      } else {
        conf.remove();
      }
    };
    requestAnimationFrame(anim);
  }

  // ====== –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª ======
  function loop(){
    if(!running) return;
    const now = Date.now();

    // —Å–ø–∞–≤–Ω
    if(now - lastSpawn > spawnInterval){
      spawnItem();
      lastSpawn = now;
    }

    // —É—Å–ª–æ–∂–Ω–µ–Ω–∏–µ: –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ —á—É—Ç—å-—á—É—Ç—å —É—Å–∫–æ—Ä—è–µ–º (–º—è–≥–∫–æ)
    if(now - difficultyTimer > 15000){
      difficultyTimer = now;
      if(spawnInterval > 400){
        spawnInterval -= 50;
      }
    }

    // –∏–Ω–æ–≥–¥–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º —é–º–æ—Ä
    if(now - humorTimer > 12000){
      humorTimer = now;
      const jokes = [
        "–ú–∞–ª—ã—à —à–µ–ø—á–µ—Ç: ¬´–µ—â—ë –æ–¥–Ω–æ —Å–µ—Ä–¥–µ—á–∫–æ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞¬ª üíï",
        "–°—Ç—Ä–µ—Å—Å –ø—ã—Ç–∞–µ—Ç—Å—è –ø—Ä–æ–±—Ä–∞—Ç—å—Å—è ‚Äî –Ω–µ –ø—É—Å–∫–∞–π –µ–≥–æ! üö´",
        "–°—á–∞—Å—Ç—å–µ –º–∞–ª—ã—à–∞ —Ä–∞—Å—Ç—ë—Ç, –∫–∞–∫ —Ç–≤–æ–∏ —Å—É–ø–µ—Ä—Å–∏–ª—ã üí™",
        "–ü—É–∑–∏–∫–æ –≥–æ–≤–æ—Ä–∏—Ç: ¬´–µ—â—ë —á—É—Ç—å-—á—É—Ç—å!¬ª üòÑ",
        "–°–æ–±–∏—Ä–∞–π –≤–∏–±—Ä–∞—Ü–∏–∏, –∫–∞–∫ —Å–æ–±–∏—Ä–∞—é—Ç –æ–±–Ω–∏–º–∞—à–∫–∏ ü§ó",
      ];
      const pick = jokes[Math.floor(Math.random()*jokes.length)];
      showTempMessage(pick, 2500);
    }

    // –¥–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ –∫ —Ü–µ–ª–∏ (–ø–ª–∞–≤–Ω–æ)
    player.x += (player.targetX - player.x) * 0.2;

    // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–¥–∞—é—â–∏—Ö
    falling.forEach(o => {
      o.y += o.speed;
      o.wobble += 0.05;
      // —Å–ª–µ–≥–∫–∞ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ
      o.x += Math.sin(o.wobble) * 0.2;
    });

    // –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
    falling = falling.filter(o => {
      // –µ—Å–ª–∏ –¥–æ—à–ª–æ –¥–æ –¥–Ω–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ —É—Ö–æ–¥–∏—Ç
      if(o.y > gameHeight + 60) return false;
      // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è —Å –∏–≥—Ä–æ–∫–æ–º
      if(
        o.x + o.size > player.x &&
        o.x < player.x + player.w &&
        o.y + o.size > player.y &&
        o.y < player.y + player.h
      ){
        if(o.type === "heart"){
          happiness = Math.min(100, happiness + 7 + Math.random()*3);
        } else if(o.type === "stress"){
          happiness -= 12 + Math.random()*6;
        }
        // —ç—Ñ—Ñ–µ–∫—Ç –º–∞–ª–µ–Ω—å–∫–∏–π
        flashEffect(o.type === "heart" ? "#55ff99" : "#ff5555");
        return false;
      }
      return true;
    });

    // —É—Ä–æ–≤–Ω–∏ / –ø–æ—Ä–∞–∂–µ–Ω–∏–µ
    if(happiness >= 100){
      happiness = 50 + Math.random()*10;
      levelUp();
    } else if(happiness <= 0){
      happiness = 0;
      gameLost();
    }

    updateUI();
    draw();

    if(running) requestAnimationFrame(loop);
  }

  // –º–µ—Ä—Ü–∞–Ω–∏–µ –ø–æ –∫—Ä–∞—è–º –ø—Ä–∏ —Å–±–æ—Ä–µ/–ø–æ–ø–∞–¥–∞–Ω–∏–∏
  let flash = {color:null, alpha:0};
  function flashEffect(color){
    flash.color = color;
    flash.alpha = 0.6;
    setTimeout(()=>{ flash.alpha=0; },120);
  }

  // ====== –†–∏—Å–æ–≤–∞–ª–∫–∞ ======
  function draw(){
    // —á–∏—Å—Ç–∏–º
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.scale(devicePixelRatio,devicePixelRatio);

    // —Ñ–æ–Ω –≥—Ä–∞–¥–∏–µ–Ω—Ç (—Ç–æ–Ω–∫–∏–π)
    const g = ctx.createLinearGradient(0,0,0,gameHeight);
    g.addColorStop(0, "#1f233c");
    g.addColorStop(1, "#0f111a");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,gameWidth,gameHeight);

    // –ø–∞–¥–∞—é—â–∏–µ –æ–±—ä–µ–∫—Ç—ã
    falling.forEach(o => {
      ctx.save();
      ctx.translate(o.x + o.size/2, o.y + o.size/2);
      if(o.type === "heart"){
        ctx.font = (o.size) + "px system-ui, apple-system";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.fillText("‚ù§Ô∏è", 0, 0);
      } else if(o.type === "stress"){
        ctx.font = (o.size) + "px system-ui, apple-system";
        ctx.textAlign="center";
        ctx.textBaseline="middle";
        ctx.fillText("üí£", 0, 0);
      }
      ctx.restore();
    });

    // –∏–≥—Ä–æ–∫ (–ø—É–∑–æ)
    ctx.save();
    // —Ç–µ–Ω—å
    ctx.fillStyle = "rgba(255,255,255,0.04)";
    ctx.roundRect(player.x -4, player.y + 4, player.w + 8, player.h + 8, 12);
    ctx.fill();

    // —Å–∞–º –ø—É–∑–∏–∫
    ctx.fillStyle = "#ff9f43";
    ctx.roundRect(player.x, player.y, player.w, player.h, 12);
    ctx.fill();

    // –Ω–∞ –ø—É–∑–∏–∫–µ: emoji –º–∞–ª—ã—à–∞
    ctx.font = "18px system-ui";
    ctx.fillStyle = "#fff";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText("ü§∞", player.x + player.w/2, player.y + player.h/2 -2);
    ctx.restore();

    // —Ä–∞–º–∫–∞ —Å—á–∞—Å—Ç—å—è (–≤–Ω–∏–∑—É)
    // —ç—Ñ—Ñ–µ–∫—Ç –≤—Å–ø—ã—à–∫–∏
    if(flash.alpha > 0){
      ctx.fillStyle = flash.color;
      ctx.globalAlpha = flash.alpha;
      ctx.fillRect(0,0,gameWidth,gameHeight);
      ctx.globalAlpha = 1;
    }

    // –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–∞—è –ø–æ–ª–æ—Å–∫–∞ —Å—á–∞—Å—Ç—å—è
    const barW = gameWidth * 0.8;
    const barH = 14;
    const barX = (gameWidth - barW)/2;
    const barY = 8;
    ctx.lineWidth=0;
    // —Ñ–æ–Ω
    ctx.fillStyle = "#1f2135";
    ctx.roundRect(barX, barY, barW, barH, 8);
    ctx.fill();
    // –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
    const fillW = (happiness/100) * barW;
    const grad = ctx.createLinearGradient(barX,0,barX+barW,0);
    grad.addColorStop(0, "#55ff99");
    grad.addColorStop(1, "#ffeb3b");
    ctx.fillStyle = grad;
    ctx.roundRect(barX, barY, fillW, barH, 8);
    ctx.fill();
    // —Ä–∞–º–∫–∞
    ctx.strokeStyle = "#444b9b";
    ctx.lineWidth=1;
    ctx.roundRect(barX, barY, barW, barH, 8);
    ctx.stroke();

    // –ø–æ–¥–ø–∏—Å—å
    ctx.font = "12px system-ui";
    ctx.fillStyle = "#fff";
    ctx.textAlign="center";
    ctx.fillText("–°—á–∞—Å—Ç—å–µ –º–∞–ª—ã—à–∞", barX + barW/2, barY + barH + 14);

    ctx.restore();
  }

  // –º–∞–ª–µ–Ω—å–∫–∞—è —É—Ç–∏–ª–∏—Ç–∞: roundRect (–≤ –±—Ä–∞—É–∑–µ—Ä–∞—Ö –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
      if (w < 0) { x = x + w; w = -w; }
      if (h < 0) { y = y + h; h = -h; }
      if (typeof r === "number") r = { tl: r, tr: r, br: r, bl: r };
      else {
        const defaultRadius = { tl: 0, tr: 0, br: 0, bl: 0 };
        for (let side in defaultRadius) {
          r[side] = r[side] || defaultRadius[side];
        }
      }
      this.beginPath();
      this.moveTo(x + r.tl, y);
      this.lineTo(x + w - r.tr, y);
      this.quadraticCurveTo(x + w, y, x + w, y + r.tr);
      this.lineTo(x + w, y + h - r.br);
      this.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
      this.lineTo(x + r.bl, y + h);
      this.quadraticCurveTo(x, y + h, x, y + h - r.bl);
      this.lineTo(x, y + r.tl);
      this.quadraticCurveTo(x, y, x + r.tl, y);
      this.closePath();
      return this;
    };
  }

  // ====== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ======
  startBtn.addEventListener("click", startGame);
  resetBtn.addEventListener("click", ()=>{
    state.bestLevel = 1;
    saveState();
    resetGame();
    updateUI();
  });
  loveBtn.addEventListener("click", ()=> {
    overlay.style.display="block";
  });
  closeLove.addEventListener("click", ()=> overlay.style.display="none");
  closeX.addEventListener("click", ()=> overlay.style.display="none");
  overlay.addEventListener("click", (e)=>{
    if(e.target === overlay) overlay.style.display="none";
  });

  nameInput.addEventListener("input", e=>{
    const v = e.target.value.trim();
    state.name = v || "–õ—é–±–∏–º–∞—è";
    saveState();
    displayNameEl.textContent = state.name;
  });

  // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  resetGame();

  // —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ best level –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
  window.addEventListener("beforeunload", ()=>{
    saveState();
  });
  </script>
</body>
</html>
